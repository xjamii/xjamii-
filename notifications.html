<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications | Aviationin</title>
    <link rel="stylesheet" href="posts.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Base Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        /* Header Styles */
        .notifications-header {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .back-button {
            color: #0056b3;
            font-size: 18px;
            text-decoration: none;
            margin-right: 15px;
        }

        .header-title {
            font-weight: 600;
            font-size: 18px;
            flex: 1;
        }

        .search-icon {
            color: #0056b3;
            font-size: 18px;
            text-decoration: none;
        }

        /* Content Styles */
        .notifications-content {
            margin-top: 60px;
            padding: 15px;
        }

        /* Notification Items */
        .notification-item {
            display: flex;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .notification-item.unread {
            background-color: #f0f7ff;
        }

        .notification-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }

        .notification-info {
            flex: 1;
        }

        .notification-message {
            margin-bottom: 5px;
            font-size: 14px;
        }

        .notification-message a {
            color: #0056b3;
            font-weight: 500;
            text-decoration: none;
        }

        .notification-time {
            color: #666;
            font-size: 12px;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .notification-action-btn {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            outline: none;
        }

        .accept-btn {
            background-color: #0056b3;
            color: white;
        }

        .ignore-btn {
            background-color: #f0f0f0;
            color: #333;
        }

        /* Loading States */
        .loading-spinner {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #e6f0ff;
            border-top: 3px solid #0056b3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-notifications {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        /* Tabs */
        .notification-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            background-color: white;
            position: sticky;
            top: 60px;
            z-index: 90;
        }

        .notification-tab {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            font-weight: 500;
            color: #666;
            cursor: pointer;
        }

        .notification-tab.active {
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
        }

        /* Unread indicator */
        .unread-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 8px;
            height: 8px;
            background-color: #0056b3;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <!-- Notifications Header -->
    <div class="notifications-header">
        <a href="index.html" class="back-button">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="header-title">Notifications</div>
        <a href="search.html" class="search-icon">
            <i class="fas fa-search"></i>
        </a>
    </div>

    <!-- Notification Tabs -->
    <div class="notification-tabs">
        <div class="notification-tab active" data-tab="all">All</div>
        <div class="notification-tab" data-tab="requests">Requests</div>
        <div class="notification-tab" data-tab="posts">Posts</div>
    </div>

    <!-- Notifications Content -->
    <div class="notifications-content">
        <div class="notifications-list" id="all-notifications">
            <!-- All notifications will be loaded here -->
        </div>
        
        <div class="notifications-list" id="requests-notifications" style="display: none;">
            <!-- Connection requests will be loaded here -->
        </div>
        
        <div class="notifications-list" id="posts-notifications" style="display: none;">
            <!-- Post notifications will be loaded here -->
        </div>

        <div class="loading-spinner" id="notifications-loading">
            <div class="spinner"></div>
        </div>

        <div class="no-notifications" id="no-notifications" style="display: none;">
            <i class="fas fa-bell-slash" style="font-size: 24px; margin-bottom: 10px;"></i>
            <div>No notifications yet</div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = "https://dadrhoxjhjbnhhrtkgbf.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhZHJob3hqaGpibmhocnRrZ2JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1OTk2NTksImV4cCI6MjA2NjE3NTY1OX0.rn2hv0sXbKJyniN3FtpNpuyTvcXP1nTLj-jpnimRMEI";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // DOM Elements
        const elements = {
            allNotifications: document.getElementById('all-notifications'),
            requestsNotifications: document.getElementById('requests-notifications'),
            postsNotifications: document.getElementById('posts-notifications'),
            loadingSpinner: document.getElementById('notifications-loading'),
            noNotifications: document.getElementById('no-notifications'),
            tabs: document.querySelectorAll('.notification-tab')
        };

        // Variables
        let currentUserId = null;
        let currentTab = 'all';

        // Event Listeners
        elements.tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Update active tab
                elements.tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTab = tab.dataset.tab;
                
                // Show the correct notifications list
                document.querySelectorAll('.notifications-list').forEach(list => {
                    list.style.display = 'none';
                });
                
                document.getElementById(`${currentTab}-notifications`).style.display = 'block';
                
                // Mark notifications as read when switching tabs
                if (currentTab === 'all') {
                    markNotificationsAsRead();
                }
            });
        });

        // Functions
        async function loadNotifications() {
            try {
                // Show loading state
                elements.loadingSpinner.style.display = 'block';
                elements.noNotifications.style.display = 'none';
                
                // Check if user is logged in
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                
                if (authError || !user) {
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUserId = user.id;
                
                // Get all notifications for the user
                const { data: notifications, error } = await supabase
                    .from('notifications')
                    .select(`
                        *,
                        sender:profiles(full_name, username, avatar_url)
                    `)
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Clear existing notifications
                elements.allNotifications.innerHTML = '';
                elements.requestsNotifications.innerHTML = '';
                elements.postsNotifications.innerHTML = '';
                
                if (!notifications || notifications.length === 0) {
                    elements.noNotifications.style.display = 'block';
                    elements.loadingSpinner.style.display = 'none';
                    return;
                }
                
                // Process and display notifications
                notifications.forEach(notification => {
                    const notificationElement = createNotificationElement(notification);
                    
                    // Add to all notifications
                    elements.allNotifications.appendChild(notificationElement.cloneNode(true));
                    
                    // Add to specific tab if applicable
                    if (notification.type === 'connection_request' || notification.type === 'connection_accepted') {
                        elements.requestsNotifications.appendChild(notificationElement.cloneNode(true));
                    } else if (notification.type === 'new_post') {
                        elements.postsNotifications.appendChild(notificationElement.cloneNode(true));
                    }
                });
                
                elements.loadingSpinner.style.display = 'none';
                
                // Mark notifications as read
                await markNotificationsAsRead();
                
            } catch (error) {
                console.error('Error loading notifications:', error);
                elements.loadingSpinner.style.display = 'none';
                elements.noNotifications.style.display = 'block';
                elements.noNotifications.innerHTML = `
                    <i class="fas fa-exclamation-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
                    <div>Failed to load notifications</div>
                    <button onclick="loadNotifications()" style="margin-top: 10px; padding: 5px 10px; background-color: #0056b3; color: white; border: none; border-radius: 5px;">Try Again</button>
                `;
            }
        }

        function createNotificationElement(notification) {
            const notificationElement = document.createElement('div');
            notificationElement.className = `notification-item ${notification.read ? '' : 'unread'}`;
            
            // Get avatar URL or generate initials
            const sender = notification.sender || {};
            const avatarUrl = sender.avatar_url || getInitialsAvatar(sender.full_name || 'U');
            
            // Determine notification content based on type
            let message = '';
            let actions = '';
            let link = '#';
            
            switch (notification.type) {
                case 'connection_request':
                    message = `<a href="/profile.html?id=${sender.id}">${sender.full_name || sender.username || 'Someone'}</a> wants to connect with you`;
                    actions = `
                        <div class="notification-actions">
                            <button class="notification-action-btn accept-btn" data-notification-id="${notification.id}" data-sender-id="${sender.id}">Accept</button>
                            <button class="notification-action-btn ignore-btn" data-notification-id="${notification.id}">Ignore</button>
                        </div>
                    `;
                    break;
                    
                case 'connection_accepted':
                    message = `<a href="/profile.html?id=${sender.id}">${sender.full_name || sender.username || 'Someone'}</a> accepted your connection request`;
                    link = `/profile.html?id=${sender.id}`;
                    break;
                    
                case 'new_post':
                    message = `<a href="/profile.html?id=${sender.id}">${sender.full_name || sender.username || 'Someone'}</a> posted something new`;
                    link = `/post.html?id=${notification.post_id}`;
                    break;
                    
                default:
                    message = notification.message || 'You have a new notification';
            }
            
            notificationElement.innerHTML = `
                <a href="${link}" class="notification-link">
                    <img src="${avatarUrl}" 
                         class="notification-avatar" 
                         onerror="this.src='${getInitialsAvatar(sender.full_name || 'U')}'">
                    <div class="notification-info">
                        <div class="notification-message">${message}</div>
                        <div class="notification-time">${formatNotificationTime(notification.created_at)}</div>
                        ${actions}
                    </div>
                    ${notification.read ? '' : '<div class="unread-indicator"></div>'}
                </a>
            `;
            
            // Add event listeners for action buttons
            if (notification.type === 'connection_request') {
                const acceptBtn = notificationElement.querySelector('.accept-btn');
                const ignoreBtn = notificationElement.querySelector('.ignore-btn');
                
                if (acceptBtn) {
                    acceptBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        await handleConnectionAction(notification.sender_id, 'accept', notification.id);
                    });
                }
                
                if (ignoreBtn) {
                    ignoreBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        await handleConnectionAction(notification.sender_id, 'ignore', notification.id);
                    });
                }
            }
            
            return notificationElement;
        }

        async function handleConnectionAction(senderId, action, notificationId) {
            try {
                if (action === 'accept') {
                    // Update connection status to 'accepted'
                    const { error } = await supabase
                        .from('connections')
                        .update({ status: 'accepted' })
                        .eq('sender_id', senderId)
                        .eq('receiver_id', currentUserId);
                    
                    if (error) throw error;
                    
                    // Create a notification for the sender
                    await createNotification(
                        senderId,
                        currentUserId,
                        'connection_accepted',
                        `${(await getProfileName(currentUserId))} accepted your connection request`
                    );
                }
                
                // Delete the notification (whether accepted or ignored)
                await supabase
                    .from('notifications')
                    .delete()
                    .eq('id', notificationId);
                
                // Reload notifications
                loadNotifications();
                
            } catch (error) {
                console.error('Error handling connection action:', error);
                alert('Failed to process request. Please try again.');
            }
        }

        async function markNotificationsAsRead() {
            try {
                if (!currentUserId) return;
                
                await supabase
                    .from('notifications')
                    .update({ read: true })
                    .eq('user_id', currentUserId)
                    .eq('read', false);
                
                // Update the notification badge count
                updateNotificationBadge();
                
            } catch (error) {
                console.error('Error marking notifications as read:', error);
            }
        }

        async function updateNotificationBadge() {
            try {
                if (!currentUserId) return;
                
                const { count, error } = await supabase
                    .from('notifications')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUserId)
                    .eq('read', false);
                
                if (error) throw error;
                
                // Update the badge in the navbar (if we're on the index page)
                const badge = document.getElementById('notificationBadge');
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count > 9 ? '9+' : count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('Error updating notification badge:', error);
            }
        }

        async function createNotification(userId, senderId, type, message, postId = null) {
            try {
                const { error } = await supabase
                    .from('notifications')
                    .insert([{
                        user_id: userId,
                        sender_id: senderId,
                        type: type,
                        message: message,
                        post_id: postId
                    }]);
                
                if (error) throw error;
                
            } catch (error) {
                console.error('Error creating notification:', error);
            }
        }

        async function getProfileName(userId) {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('full_name, username')
                    .eq('id', userId)
                    .single();
                
                if (error) throw error;
                
                return data.full_name || data.username || 'User';
                
            } catch (error) {
                console.error('Error getting profile name:', error);
                return 'User';
            }
        }

        function formatNotificationTime(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return date.toLocaleDateString();
        }

        function getInitialsAvatar(name) {
            const initials = name ? 
                name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'U';
            return `data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' width='50' height='50'><rect width='50' height='50' fill='%230056b3'/><text x='50%' y='50%' font-size='20' fill='white' text-anchor='middle' dy='.3em'>${initials}</text></svg>`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadNotifications();
            
            // Set up real-time notifications
            setupNotificationListener();
        });

        // Real-time notification listener
        let notificationChannel = null;
        
        async function setupNotificationListener() {
            const { data: { user }, error } = await supabase.auth.getUser();
            if (error || !user) return;
            
            if (notificationChannel) {
                supabase.removeChannel(notificationChannel);
            }
            
            notificationChannel = supabase
                .channel('notifications')
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'notifications',
                        filter: `user_id=eq.${user.id}`
                    },
                    (payload) => {
                        // If we're on the notifications page, reload the list
                        if (window.location.pathname.includes('notifications.html')) {
                            loadNotifications();
                        } else {
                            // Otherwise, just update the badge count
                            updateNotificationBadge();
                        }
                    }
                )
                .subscribe();
        }
    </script>
</body>
</html>
