<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#ECEFF1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - Xjamii</title>
   <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // ✅ Initialize Supabase
    const supabaseUrl = "https://dadrhoxjhjbnhhrtkgbf.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhZHJob3hqaGpibmhocnRrZ2JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1OTk2NTksImV4cCI6MjA2NjE3NTY1OX0.rn2hv0sXbKJyniN3FtpNpuyTvcXP1nTLj-jpnimRMEI";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey); </script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #ECEFF1;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Preloader Styles */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ECEFF1;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .preloader-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            position: relative;
        }

        .preloader-spinner-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #000;
            animation: spinner-bounce 1.4s infinite ease-in-out both;
        }

        .preloader-spinner-dot:nth-child(1) {
            top: 0;
            left: 16px;
            animation-delay: -0.32s;
        }

        .preloader-spinner-dot:nth-child(2) {
            top: 16px;
            left: 0;
            animation-delay: -0.16s;
        }

        .preloader-spinner-dot:nth-child(3) {
            top: 16px;
            left: 32px;
        }

        .preloader-spinner-dot:nth-child(4) {
            top: 32px;
            left: 16px;
            animation-delay: -0.48s;
        }

        /* Main Content Styles */
        .main-content {
            display: none;
            flex: 1;
            padding: 40px 30px 80px;
            box-sizing: border-box;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo {
            height: 60px;
            width: auto;
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            margin: 0 0 40px;
            color: #000;
            text-align: left;
        }

        .form-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .input-container {
            position: relative;
            margin-bottom: 25px;
        }

        .input-field {
            width: 100%;
            padding: 18px 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
            box-sizing: border-box;
            background-color: #ECEFF1;
        }

        .input-field:focus {
            outline: none;
            border-color: #000;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            color: #000;
        }

        /* Button Footer */
        .button-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            background-color: #ECEFF1;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            box-sizing: border-box;
        }

        .action-button {
            width: 48%;
            height: 50px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .back-button {
            background-color: #ECEFF1;
            color: #000;
            border: 2px solid #000;
        }

        .continue-button {
            background-color: #000;
            color: #fff;
            border: 2px solid #000;
        }

        .back-button:hover {
            background-color: #f0f0f0;
        }

        .continue-button:hover {
            background-color: #333;
        }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            position: relative;
        }

        .spinner-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            animation: spinner-bounce 1.4s infinite ease-in-out both;
        }

        .spinner-dot:nth-child(1) {
            top: 0;
            left: 9px;
            animation-delay: -0.32s;
        }

        .spinner-dot:nth-child(2) {
            top: 9px;
            left: 0;
            animation-delay: -0.16s;
        }

        .spinner-dot:nth-child(3) {
            top: 9px;
            left: 18px;
        }

        .spinner-dot:nth-child(4) {
            top: 18px;
            left: 9px;
            animation-delay: -0.48s;
        }

        @keyframes spinner-bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Error message */
        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
            padding: 5px;
        }
    </style>
</head>
<body>
    <!-- Preloader -->
    <div class="preloader">
        <div class="preloader-spinner">
            <div class="preloader-spinner-dot"></div>
            <div class="preloader-spinner-dot"></div>
            <div class="preloader-spinner-dot"></div>
            <div class="preloader-spinner-dot"></div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="logo-container">
            <img 
                src="https://i.postimg.cc/dDPMSQzN/file-00000000393061f8ab41ab42d88c9f40.png" 
                alt="X-Aviation Logo" 
                class="logo" 
                loading="eager"
                width="60"
                onerror="this.style.display='none'"
            >
        </div>
        
        <div class="form-container">
            <h1 class="title">Create your account</h1>
            
            <div class="input-container">
                <input type="text" class="input-field" id="name" placeholder="Name">
                <div class="error-message" id="name-error"></div>
            </div>
            
            <div class="input-container">
                <input type="email" class="input-field" id="email" placeholder="Email">
                <div class="error-message" id="email-error"></div>
            </div>
        </div>
    </div>

    <!-- Button Footer -->
    <div class="button-footer">
        <button class="action-button back-button" id="back-btn">
            <span class="btn-text">Back</span>
            <span class="spinner" style="display: none;">
                <span class="spinner-dot" style="color: #000;"></span>
                <span class="spinner-dot" style="color: #000;"></span>
                <span class="spinner-dot" style="color: #000;"></span>
                <span class="spinner-dot" style="color: #000;"></span>
            </span>
        </button>
        <button class="action-button continue-button" id="continue-btn">
            <span class="btn-text">Continue</span>
            <span class="spinner" style="display: none;">
                <span class="spinner-dot" style="color: #fff;"></span>
                <span class="spinner-dot" style="color: #fff;"></span>
                <span class="spinner-dot" style="color: #fff;"></span>
                <span class="spinner-dot" style="color: #fff;"></span>
            </span>
        </button>
    </div>
<script>
        


// DOM Elements
const usernameInput = document.getElementById('username');
const continueBtn = document.getElementById('continue-btn');
const inputStatus = document.getElementById('input-status');
const usernameError = document.getElementById('username-error');
const usernameSuccess = document.getElementById('username-success');
const suggestionsContainer = document.getElementById('suggestions-container');

// Get user ID from URL if available
const urlParams = new URLSearchParams(window.location.search);
const userId = urlParams.get('id');

// Debounce helper
let debounceTimer;
function debounce(func, delay) {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(func, delay);
}

// Validate username format
function isValidUsername(username) {
  return /^[a-zA-Z0-9_]{5,20}$/.test(username);
}

// Check username availability with Supabase
async function checkUsernameAvailability(username) {
  if (!isValidUsername(username)) return false;
  const { data } = await supabase
    .from('profiles')  // ← Changed from Profiles to profiles
    .select('id')
    .eq('username', username)
    .maybeSingle();
  return !data;
}

// Generate username suggestions
function generateSuggestions(base) {
  const suggestions = [];
  const cleanBase = base.toLowerCase().replace(/[^a-z0-9_]/g, '');
  if (!cleanBase) return suggestions;

  suggestions.push(`${cleanBase}${Math.floor(100 + Math.random() * 900)}`);
  suggestions.push(`${cleanBase}_${Math.floor(10 + Math.random() * 90)}`);
  suggestions.push(`${cleanBase}${String.fromCharCode(97 + Math.floor(Math.random() * 26))}`);
  suggestions.push(`the_${cleanBase}`);
  suggestions.push(`${cleanBase}${Math.floor(1000 + Math.random() * 9000)}`);
  return suggestions;
}

// Show suggestions
async function showSuggestions(suggestions) {
  suggestionsContainer.innerHTML = '';
  for (const suggestion of suggestions) {
    const pill = document.createElement('div');
    pill.className = 'suggestion-pill loading';
    pill.innerHTML = `${suggestion}<span class="status-icon"><i class="fas fa-circle-notch fa-spin"></i></span>`;
    suggestionsContainer.appendChild(pill);

    const isAvailable = await checkUsernameAvailability(suggestion);
    pill.className = isAvailable ? 'suggestion-pill available' : 'suggestion-pill unavailable';
    pill.innerHTML = `${suggestion}<span class="status-icon"><i class="fas ${isAvailable ? 'fa-check' : 'fa-times'}"></i></span>`;

    pill.addEventListener('click', () => {
      usernameInput.value = suggestion;
      updateUsernameStatus(suggestion);
    });
  }
}

// Validate & update status
async function updateUsernameStatus(username) {
  inputStatus.className = 'input-status checking';
  inputStatus.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
  usernameError.style.display = usernameSuccess.style.display = 'none';
  continueBtn.disabled = true;
  suggestionsContainer.innerHTML = '';

  if (!username) {
    inputStatus.innerHTML = '';
    return;
  }

  if (isValidUsername(username)) {
    const isAvailable = await checkUsernameAvailability(username);
    if (isAvailable) {
      inputStatus.className = 'input-status available';
      inputStatus.innerHTML = '<i class="fas fa-check"></i>';
      usernameSuccess.style.display = 'block';
      usernameSuccess.textContent = 'Username is available!';
      continueBtn.disabled = false;
    } else {
      inputStatus.className = 'input-status unavailable';
      inputStatus.innerHTML = '<i class="fas fa-times"></i>';
      usernameError.style.display = 'block';
      usernameError.textContent = 'This username is not available.';
      showSuggestions(generateSuggestions(username));
    }
  } else {
    inputStatus.className = 'input-status unavailable';
    inputStatus.innerHTML = '<i class="fas fa-times"></i>';
    usernameError.style.display = 'block';
    usernameError.textContent = 'Username must be 5-20 chars (letters, numbers, or underscores).';
  }
}

// Load existing username if available
supabase.auth.getUser().then(async ({ data: { user } }) => {
  if (!user) return (window.location.href = 'signin.html');

  // Use userId from URL if available, otherwise use authenticated user's ID
  const targetUserId = userId || user.id;

  // Fetch existing username
  const { data: profile } = await supabase.from('profiles')  // ← Changed from Profiles to profiles
    .select('username, accountComplete')
    .eq('id', targetUserId)
    .single();

  if (profile?.username) {
    // Existing username — just show it
    usernameInput.value = profile.username;
    await updateUsernameStatus(profile.username);
    
    // If account is already complete, redirect
    if (profile.accountComplete) {
      window.location.href = 'index.html';
    }
    return;
  }

  // No username set — generate one
  const name = user.user_metadata?.full_name || user.email?.split('@')[0] || '';
  const suggestedUsername = `${name.toLowerCase().replace(/[^a-z0-9_]/g, '')}${Math.floor(100 + Math.random() * 900)}`;
  usernameInput.value = suggestedUsername;
  await updateUsernameStatus(suggestedUsername);
});

// Input listener
usernameInput.addEventListener('input', () => {
  debounce(() => updateUsernameStatus(usernameInput.value.trim()), 500);
});

// Save username
continueBtn.addEventListener('click', async () => {
  const username = usernameInput.value.trim().toLowerCase();
  if (!isValidUsername(username)) return;

  const isAvailable = await checkUsernameAvailability(username);
  if (!isAvailable) {
    usernameError.style.display = 'block';
    usernameError.textContent = 'This username is no longer available.';
    return;
  }

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return;

  // Use userId from URL if available, otherwise use authenticated user's ID
  const targetUserId = userId || user.id;

  const { error } = await supabase.from('profiles').update({  // ← Changed from Profiles to profiles
    username,
    accountComplete: true 
  }).eq('id', targetUserId);

  if (error) {
    usernameError.style.display = 'block';
    usernameError.textContent = 'Error saving username. Please try again.';
    return;
  }

  window.location.href = 'index.html';
});

// Show error message
function showError(message) {
  usernameError.style.display = 'block';
  usernameError.textContent = message;
  usernameError.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
</script>
</body>
</html>
