<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#ECEFF1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Username - Xjamii</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  const supabaseUrl = "https://dadrhoxjhjbnhhrtkgbf.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhZHJob3hqaGpibmhocnRrZ2JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1OTk2NTksImV4cCI6MjA2NjE3NTY1OX0.rn2hv0sXbKJyniN3FtpNpuyTvcXP1nTLj-jpnimRMEI";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
</script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #ECEFF1;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            padding: 20px 30px;
            box-sizing: border-box;
        }

        .logo-container {
            text-align: center;
            margin: 30px 0 20px;
        }

        .logo {
            height: 60px;
            width: auto;
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            margin: 0 0 30px;
            color: #000;
            text-align: center;
        }

        .form-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .input-container {
            position: relative;
            margin-bottom: 25px;
        }

        .text-input {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: #ECEFF1;
            padding-right: 40px; /* Space for status icon */
        }

        .text-input:focus {
            outline: none;
            border-color: #000;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            color: #000;
        }

        .button-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px 20px;
            background-color: #ECEFF1;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            box-sizing: border-box;
        }

        .continue-button {
            width: 100%;
            max-width: 500px;
            height: 50px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background-color: #000;
            color: #fff;
            border: 2px solid #000;
        }

        .continue-button:disabled {
            background-color: #cccccc;
            border-color: #cccccc;
            cursor: not-allowed;
        }

        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .success-message {
            color: #2ecc71;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .suggestions-container {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-pill {
            padding: 6px 12px;
            background-color: #E0E0E0;
            border-radius: 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-pill:hover {
            background-color: #BDBDBD;
        }

        .checking-message {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .suggestion-pill.loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .input-status.available {
            color: #2ecc71; /* Changed from blue to green */
            display: block;
        }

        .input-status.unavailable {
            color: #ed4956;
            display: block;
        }

        .input-status.checking {
            color: #999;
            display: block;
        }

        /* Suggestion pills with status */
        .suggestion-pill {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            margin: 4px;
            background: #f0f0f0;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-pill:hover {
            background: #e0e0e0;
        }

        .suggestion-pill .status-icon {
            margin-left: 5px;
            font-size: 12px;
        }

        .suggestion-pill.available {
            background-color: #e8f5e9; /* Light green background */
            color: #2ecc71; /* Green text */
        }

        .suggestion-pill.available .status-icon {
            color: #2ecc71;
        }

        .suggestion-pill.unavailable {
            background-color: #ffebee;
            color: #ed4956;
        }

        .suggestion-pill.unavailable .status-icon {
            color: #ed4956;
        }

       /* Remove the old positioning and add these new styles */
.input-status {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    display: none;
    pointer-events: none; /* Prevents interaction with the icon */
}

/* Adjust the input padding to ensure text doesn't overlap the icon */
.text-input {
    padding-right: 40px !important; /* Make sure this is larger than the icon */
}

/* Container needs relative positioning */
.input-container {
    position: relative;
}

/* Make sure the input container has proper spacing */
.input-container div {
    position: relative;
} 
    </style>
</head>
<body>
    <div class="main-content">
        <div class="logo-container">
            <img src="https://i.postimg.cc/dDPMSQzN/file-00000000393061f8ab41ab42d88c9f40.png" alt="X-Aviation Logo" class="logo">
        </div>
        
        <div class="form-container">
            <h1 class="title">Create your username</h1>
            
            <div class="input-container">
                <label for="username" class="input-label">Username</label>
                <div style="position: relative;">
                    <input type="text" class="text-input" id="username" placeholder="Enter your username" autocapitalize="off" autocorrect="off">
                    <span class="input-status" id="input-status"></span>
                </div>
                <div class="error-message" id="username-error"></div>
                <div class="success-message" id="username-success"></div>
                <div class="checking-message" id="checking-message">Checking availability...</div>
                
                <div class="suggestions-container" id="suggestions-container"></div>
            </div>
        </div>
    </div>

    <div class="button-footer">
        <button class="continue-button" id="continue-btn" disabled>Continue</button>
    </div>
    <script>
                      
      // DOM Elements (unchanged)
const usernameInput = document.getElementById('username');
const continueBtn = document.getElementById('continue-btn');
const inputStatus = document.getElementById('input-status');
const usernameError = document.getElementById('username-error');
const usernameSuccess = document.getElementById('username-success');
const suggestionsContainer = document.getElementById('suggestions-container');

// Get user ID (unchanged)
const urlParams = new URLSearchParams(window.location.search);
const userId = urlParams.get('id');

// Debounce helper (unchanged)
let debounceTimer;
function debounce(func, delay) {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(func, delay);
}

// Updated username validation (changed minimum to 1)
function isValidUsername(username) {
  return /^[a-z0-9_]{1,20}$/.test(username); // Changed from {3,20} to {1,20}
}

// Check username availability (unchanged except validation)
async function checkUsernameAvailability(username) {
  if (!isValidUsername(username)) return false;
  
  const { data } = await supabase
    .from('profiles')
    .select('id')
    .eq('username', username)
    .neq('id', userId)
    .maybeSingle();
  
  return !data;
}

// Generate suggestions (unchanged)
function generateSuggestions(base) {
  const suggestions = [];
  const cleanBase = base.toLowerCase().replace(/[^a-z0-9]/g, '');
  if (!cleanBase) return suggestions;

  suggestions.push(`${cleanBase}${Math.floor(100 + Math.random() * 900)}`);
  suggestions.push(`${cleanBase}_${Math.floor(10 + Math.random() * 90)}`);
  suggestions.push(`${cleanBase}${String.fromCharCode(97 + Math.floor(Math.random() * 26))}`);
  suggestions.push(`the_${cleanBase}`);
  return suggestions;
}

// Show suggestions (unchanged)
async function showSuggestions(suggestions) {
  suggestionsContainer.innerHTML = '';
  
  for (const suggestion of suggestions) {
    const pill = document.createElement('div');
    pill.className = 'suggestion-pill loading';
    pill.innerHTML = `${suggestion}<span class="status-icon"><i class="fas fa-circle-notch fa-spin"></i></span>`;
    suggestionsContainer.appendChild(pill);

    const isAvailable = await checkUsernameAvailability(suggestion);
    
    pill.className = isAvailable ? 'suggestion-pill available' : 'suggestion-pill unavailable';
    pill.innerHTML = `${suggestion}<span class="status-icon"><i class="fas ${isAvailable ? 'fa-check' : 'fa-times'}"></i></span>`;

    if (isAvailable) {
      pill.addEventListener('click', () => {
        usernameInput.value = suggestion;
        updateUsernameStatus(suggestion);
      });
    }
  }
}

// Updated validation message (changed from 3-20 to 1-20)
async function updateUsernameStatus(username) {
  inputStatus.className = 'input-status checking';
  inputStatus.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
  usernameError.style.display = usernameSuccess.style.display = 'none';
  continueBtn.disabled = true;

  if (!username) {
    inputStatus.innerHTML = '';
    return;
  }

  if (isValidUsername(username)) {
    const isAvailable = await checkUsernameAvailability(username);
    
    if (isAvailable) {
      inputStatus.className = 'input-status available';
      inputStatus.innerHTML = '<i class="fas fa-check"></i>';
      usernameSuccess.style.display = 'block';
      usernameSuccess.textContent = 'Username is available!';
      continueBtn.disabled = false;
    } else {
      inputStatus.className = 'input-status unavailable';
      inputStatus.innerHTML = '<i class="fas fa-times"></i>';
      usernameError.style.display = 'block';
      usernameError.textContent = 'This username is not available.';
      showSuggestions(generateSuggestions(username));
    }
  } else {
    inputStatus.className = 'input-status unavailable';
    inputStatus.innerHTML = '<i class="fas fa-times"></i>';
    usernameError.style.display = 'block';
    usernameError.textContent = 'Username must be 1-20 chars (letters, numbers, _)'; // Updated message
  }
}

// Load current username (unchanged)
async function loadCurrentUsername() {
  const { data: profile, error } = await supabase
    .from('profiles')
    .select('username, full_name')
    .eq('id', userId)
    .single();

  if (profile?.username) {
    usernameInput.value = profile.username.split('_')[0];
    usernameInput.setAttribute('data-original-username', profile.username);
    await updateUsernameStatus(profile.username);
  }
}

// Initialize page (unchanged)
supabase.auth.getUser().then(async ({ data: { user } }) => {
  if (!user) return (window.location.href = 'signin.html');
  
  const targetUserId = userId || user.id;
  await loadCurrentUsername();
  
  if (!usernameInput.value) {
    const name = user.user_metadata?.full_name || user.email?.split('@')[0] || '';
    usernameInput.value = name.toLowerCase().replace(/[^a-z0-9]/g, '');
    await updateUsernameStatus(usernameInput.value);
  }
});

// Real-time input listener (unchanged)
usernameInput.addEventListener('input', () => {
  debounce(() => updateUsernameStatus(usernameInput.value.trim()), 500);
});

// Save handler with updated validation message
continueBtn.addEventListener('click', async () => {
  const newUsername = usernameInput.value.trim().toLowerCase();
  const originalUsername = usernameInput.getAttribute('data-original-username');
  
  // Updated validation message
  if (!isValidUsername(newUsername)) {
    showError('Username must be 1-20 chars (letters, numbers, _)'); // Changed from 3-20
    return;
  }

  const isAvailable = await checkUsernameAvailability(newUsername);
  if (!isAvailable) {
    showError('Username was taken just now. Please try another.');
    return;
  }

  const { error } = await supabase
    .from('profiles')
    .update({ username: newUsername })
    .eq('id', userId);

  if (error) {
    showError(error.message.includes('unique') 
      ? 'Username was taken. Try another.' 
      : 'Update failed. Please try again.');
    return;
  }

  window.location.href = 'index.html';
});

// Helper function (unchanged)
function showError(message) {
  usernameError.style.display = 'block';
  usernameError.textContent = message;
  usernameError.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
    </script>
</body>
</html>
