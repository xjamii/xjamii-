<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviationin Profile</title>
    <link rel="stylesheet" href="posts.css">
    <link rel="stylesheet" href="edit.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* [Keep all your existing CSS styles] */
     /* Base Styles */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f5f7fa;
    color: #333;
    line-height: 1.6;
}

/* Header Styles */
.profile-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background-color: white;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.back-button {
    color: #0056b3;
    font-size: 18px;
    text-decoration: none;
}

.header-name {
    font-weight: 600;
    font-size: 18px;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}

.edit-button, .more-options {
    color: #0056b3;
    font-size: 16px;
    cursor: pointer;
    display: none;
}

/* Profile Content Styles */
.profile-content {
    margin-top: 60px;
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    margin-bottom: 20px;
}

.cover-photo {
    height: 150px;
    background-color: #0056b3;
    background-size: cover;
    background-position: center;
    position: relative;
}

/* Profile Info Styles */
.profile-info {
    text-align: center;
    padding: 20px;
    position: relative;
    margin-top: -70px;
}

.avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 5px solid white;
    object-fit: cover;
    margin-bottom: 15px;
}

.profile-details {
    margin-top: 10px;
}

.profile-name {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 5px;
    margin-bottom: 5px;
}

.profile-name h1 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
}

.verified-badge {
    color: #0056b3;
    font-size: 16px;
    display: none;
}

.username {
    color: #666;
    font-size: 16px;
    margin-bottom: 10px;
}

.connections {
    color: #666;
    font-size: 14px;
    margin-bottom: 15px;
}

.bio {
    color: #444;
    font-size: 15px;
    margin: 15px auto;
    max-width: 80%;
    line-height: 1.5;
}

.website-link {
    color: #0056b3;
    text-decoration: none;
    font-size: 14px;
    display: block;
    margin-bottom: 15px;
}

.category-badge {
    background-color: #e6f0ff;
    color: #0056b3;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    display: inline-block;
    margin-bottom: 15px;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
}

.btn {
    padding: 10px 20px;
    border-radius: 20px;
    border: none;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn {
    background-color: #0056b3;
    color: white;
}

.btn-outline {
    background-color: white;
    color: #0056b3;
    border: 1px solid #0056b3;
}

.btn:hover {
    opacity: 0.9;
    transform: translateY(-2px);
}

/* Experience Section */
.experience-section, .skills-section {
    padding: 20px;
    border-top: 1px solid #eee;
}

.section-title {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 15px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
}

.experience-item {
    margin-bottom: 15px;
}

.experience-details {
    margin-left: 10px;
}

.experience-details .description {
    color: #444;
    font-size: 14px;
    line-height: 1.6;
}

/* Skills Section */
.skills-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.skill-badge {
    background-color: #f0f4f8;
    color: #0056b3;
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 13px;
    font-weight: 500;
}

/* Responsive Adjustments */
@media (max-width: 480px) {
    .profile-info {
        padding: 15px;
    }
    
    .bio {
        max-width: 95%;
    }
    
    .action-buttons {
        flex-direction: column;
        align-items: center;
    }
    
    .btn {
        width: 100%;
        max-width: 200px;
    }
}

/* [Keep all your existing skeleton loader styles here] */
.profile-details-skeleton {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    position: relative;
    margin-top: 70px;
}

.skeleton-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background-color: #e0e0e0;
    position: absolute;
    top: -60px;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid white;
}

.skeleton-name {
    width: 200px;
    height: 30px;
    background-color: #e0e0e0;
    margin-bottom: 10px;
    border-radius: 4px;
}

.skeleton-username {
    width: 150px;
    height: 20px;
    background-color: #e0e0e0;
    margin-bottom: 15px;
    border-radius: 4px;
}

.skeleton-bio {
    width: 80%;
    height: 60px;
    background-color: #e0e0e0;
    margin-bottom: 15px;
    border-radius: 4px;
}

.skeleton-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.skeleton-stat {
    width: 60px;
    height: 20px;
    background-color: #e0e0e0;
    border-radius: 4px;
}

.skeleton-button {
    width: 100px;
    height: 40px;
    background-color: #e0e0e0;
    border-radius: 20px;
    margin-bottom: 15px;
}

.skeleton-shimmer {
    background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.error-message {
    color: #ff4444;
    text-align: center;
    padding: 20px;
    font-weight: 500;
    display: none;
}
        
        

        
    </style>
</head>
<body>
    <!-- Header with Back Button and Options -->
    <div class="profile-header">
        <div class="header-left">
            <a href="index.html" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="header-name" id="profile-name">Profile</div>
        </div>
        <div class="header-actions">
            <div class="edit-button" id="edit-button">
                <i class="fas fa-pencil-alt"></i>
            </div>
            <div class="more-options" onclick="toggleOptions()">
                <i class="fas fa-ellipsis-h"></i>
            </div>
        </div>
    </div>

    <!-- Profile Content -->
    <div class="profile-content">
        <div class="cover-photo" id="cover-photo"></div>
        
        <!-- Skeleton Loader for Profile Details Only -->
        <div class="profile-details-skeleton" id="profile-details-skeleton">
            <div class="skeleton-avatar skeleton-shimmer"></div>
            <div class="skeleton-name skeleton-shimmer"></div>
            <div class="skeleton-username skeleton-shimmer"></div>
            <div class="skeleton-bio skeleton-shimmer"></div>
            <div class="skeleton-stats">
                <div class="skeleton-stat skeleton-shimmer"></div>
                <div class="skeleton-stat skeleton-shimmer"></div>
                <div class="skeleton-stat skeleton-shimmer"></div>
            </div>
            <div class="skeleton-button skeleton-shimmer"></div>
        </div>
        
        <!-- Error Message Container -->
        <div class="error-message" id="error-message"></div>
        
        <!-- Actual Profile Content (hidden initially) -->
        <div class="profile-info" id="profile-info" style="display: none;">
            <img src="" alt="Profile Avatar" class="avatar" id="profile-avatar">
            <div class="profile-details">
                <div class="profile-name">
                    <h1 id="full-name">Loading...</h1>
                    <i class="fas fa-check-circle verified-badge" id="verified-badge"></i>
                </div>
                <div class="username" id="username">@loading</div>
                <div class="connections">
                    <i class="fas fa-link"></i> <span id="connections-count">0</span> Connections
                </div>
                <p class="bio" id="bio">
                    Loading profile information...
                </p>
                <a href="#" class="website-link" id="website-link" style="display: none;"></a>
                <div class="category-badge" id="category-badge" style="display: none;"></div>
                <div class="action-buttons">
                    <button class="btn" id="connect-btn">Connect</button>
                    <button class="btn btn-outline">Message</button>
                    <button class="btn btn-outline" onclick="shareProfile()"><i class="fas fa-share"></i></button>
                </div>
            </div>
        </div>

        <!-- Experience Section -->
        <div class="experience-section" id="experience-section" style="display: none;">
            <h2 class="section-title"><i class="fas fa-briefcase"></i> Professional Experience</h2>
            <div id="experience-container">
                <div class="experience-item">
                    <div class="experience-details">
                        <div class="description" id="experience-text">Loading experience...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Skills Section -->
        <div class="skills-section" id="skills-section" style="display: none;">
            <h2 class="section-title"><i class="fas fa-star"></i> Skills & Endorsements</h2>
            <div class="skills-list" id="skills-container">
                <div class="skill-badge">Loading skills...</div>
            </div>
        </div>
    </div>


    <div id="user-posts">
        <!-- User posts will be loaded here -->
    </div>
    
    <!-- Edit Profile Modal -->
    <div class="modal-overlay" id="edit-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Profile</h3>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-profile-form">
                    <div class="form-group">
                        <label for="edit-avatar">Profile Picture</label>
                        <img id="avatar-preview" class="avatar-preview" src="" alt="Avatar Preview">
                        <label for="edit-avatar-upload" class="file-input-label">
                            <i class="fas fa-camera"></i> Change Photo
                        </label>
                        <input type="file" id="edit-avatar-upload" class="file-input" accept="image/*">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-cover">Cover Photo</label>
                        <img id="cover-preview" class="cover-preview" src="" alt="Cover Preview">
                        <label for="edit-cover-upload" class="file-input-label">
                            <i class="fas fa-camera"></i> Change Cover
                        </label>
                        <input type="file" id="edit-cover-upload" class="file-input" accept="image/*">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-full-name">Full Name</label>
                        <input type="text" id="edit-full-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-username">Username</label>
                        <input type="text" id="edit-username" required>
                        <div class="username-availability" id="username-availability"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-bio">Bio</label>
                        <textarea id="edit-bio"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-website">Website</label>
                        <input type="url" id="edit-website" placeholder="https://example.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-category">Professional Category</label>
                        <select id="edit-category">
                            <option value="">Select Category</option>
                            <option value="Pilot">Pilot</option>
                            <option value="Flight Attendant">Flight Attendant</option>
                            <option value="Engineer">Aircraft Engineer</option>
                            <option value="Air Traffic Controller">Air Traffic Controller</option>
                            <option value="Management">Management</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-experience">Professional Experience</label>
                        <textarea id="edit-experience" placeholder="Describe your professional background"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-skills">Skills (comma separated)</label>
                        <textarea id="edit-skills" placeholder="e.g., CRM, Flight Planning, Safety Management"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-cancel" id="cancel-edit">Cancel</button>
                        <button type="submit" class="btn btn-save">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
     // Initialize Supabase
const supabaseUrl = "https://dadrhoxjhjbnhhrtkgbf.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhZHJob3hqaGpibmhocnRrZ2JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1OTk2NTksImV4cCI6MjA2NjE3NTY1OX0.rn2hv0sXbKJyniN3FtpNpuyTvcXP1nTLj-jpnimRMEI";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Get profile ID from URL or current user
const urlParams = new URLSearchParams(window.location.search);
let profileId = urlParams.get('id');

// DOM Elements
const elements = {
    skeleton: document.getElementById('profile-details-skeleton'),
    errorMessage: document.getElementById('error-message'),
    profileInfo: document.getElementById('profile-info'),
    experienceSection: document.getElementById('experience-section'),
    skillsSection: document.getElementById('skills-section'),
    profileName: document.getElementById('profile-name'),
    fullName: document.getElementById('full-name'),
    username: document.getElementById('username'),
    bio: document.getElementById('bio'),
    websiteLink: document.getElementById('website-link'),
    categoryBadge: document.getElementById('category-badge'),
    profileAvatar: document.getElementById('profile-avatar'),
    coverPhoto: document.getElementById('cover-photo'),
    experienceContainer: document.getElementById('experience-container'),
    skillsContainer: document.getElementById('skills-container'),
    verifiedBadge: document.getElementById('verified-badge'),
    connectionsCount: document.getElementById('connections-count'),
    connectBtn: document.getElementById('connect-btn'),
    editButton: document.getElementById('edit-button')
};

// Load profile data
async function loadProfile() {
    try {
        // Show skeleton loader
        elements.skeleton.style.display = 'flex';
        elements.errorMessage.style.display = 'none';
        
        // Check if user is logged in
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        
        if (authError || !user) {
            window.location.href = 'login.html';
            return;
        }
        
        // If no profile ID in URL, use current user's ID
        if (!profileId) {
            profileId = user.id;
        }
        
        // Get profile data
        const { data: profile, error: profileError } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', profileId)
            .single();

        if (profileError) throw profileError;
        if (!profile) throw new Error('Profile not found');
        
        // Get connections count
        const { count: connectionsCount, error: connectionsError } = await supabase
            .from('connections')
            .select('*', { count: 'exact', head: true })
            .or(`and(sender_id.eq.${profileId},status.eq.accepted),and(receiver_id.eq.${profileId},status.eq.accepted)`);

        if (connectionsError) console.error('Error getting connections:', connectionsError);
        
        // Populate profile data
        elements.profileName.textContent = profile.full_name || 'Profile';
        elements.fullName.textContent = profile.full_name || 'New User';
        elements.username.textContent = `@${profile.username_slug || profile.username || 'user'}`;
        elements.connectionsCount.textContent = connectionsCount || 0;
        
        // Set bio if available
        elements.bio.textContent = profile.bio || `${profile.full_name || 'User'} is an aviation professional.`;
        
        // Set website if available
        if (profile.website) {
            elements.websiteLink.textContent = profile.website;
            elements.websiteLink.href = profile.website.startsWith('http') ? 
                profile.website : `https://${profile.website}`;
            elements.websiteLink.style.display = 'inline-block';
        }
        
        // Set category if available
        if (profile.category) {
            elements.categoryBadge.textContent = profile.category;
            elements.categoryBadge.style.display = 'inline-block';
        }
        
        // Set avatar image
        if (profile.avatar_url) {
            elements.profileAvatar.src = profile.avatar_url;
        } else {
            // Fallback to initials avatar
            const initials = profile.full_name ? 
                profile.full_name.split(' ').map(n => n[0]).join('') : 'U';
            elements.profileAvatar.src = `https://ui-avatars.com/api/?name=${initials}&background=0056b3&color=fff&size=120`;
        }
        
        // Set cover photo
        if (profile.cover_photo_url) {
            elements.coverPhoto.style.backgroundImage = `linear-gradient(rgba(0, 86, 179, 0.7), rgba(0, 86, 179, 0.7)), url('${profile.cover_photo_url}')`;
        }
        
        // Set experience
        if (profile.experience) {
            elements.experienceContainer.innerHTML = `
                <div class="experience-item">
                    <div class="experience-details">
                        <div class="description">${profile.experience}</div>
                    </div>
                </div>`;
        }
        
        // Set skills
        if (profile.skills) {
            const skillsArray = profile.skills.split(',').map(skill => skill.trim());
            elements.skillsContainer.innerHTML = skillsArray
                .filter(skill => skill.length > 0)
                .map(skill => `<div class="skill-badge">${skill}</div>`)
                .join('');
        }
        
        // Show verified badge if email is verified
        elements.verifiedBadge.style.display = 'inline-block';

        // Check connection status if viewing another user's profile
        if (user.id !== profileId) {
            await checkConnectionStatus(user.id, profileId);
        } else {
            elements.connectBtn.style.display = 'none';
            elements.editButton.style.display = 'block';
            elements.editButton.onclick = openEditModal; // Directly use modal for own profile
        }

        // Hide skeleton and show content
        elements.skeleton.style.display = 'none';
        elements.profileInfo.style.display = 'block';
        elements.experienceSection.style.display = 'block';
        elements.skillsSection.style.display = 'block';

    } catch (error) {
        console.error('Error loading profile:', error);
        showError(error.message || 'Failed to load profile. Please try again later.');
    }
}

// Connection management
async function checkConnectionStatus(currentUserId, profileId) {
    try {
        const { data, error } = await supabase
            .from('connections')
            .select('id, sender_id, status')
            .or(`and(sender_id.eq.${currentUserId},receiver_id.eq.${profileId}),and(sender_id.eq.${profileId},receiver_id.eq.${currentUserId})`)
            .single();

        if (error && error.code !== 'PGRST116') throw error; // Ignore "No rows found" error
        
        if (data) {
            if (data.status === 'pending') {
                if (data.sender_id === currentUserId) {
                    elements.connectBtn.textContent = 'Pending';
                    elements.connectBtn.disabled = true;
                } else {
                    elements.connectBtn.textContent = 'Accept';
                    elements.connectBtn.onclick = () => acceptConnection(data.id);
                }
            } else if (data.status === 'accepted') {
                elements.connectBtn.textContent = 'Connected';
                elements.connectBtn.disabled = true;
            }
        } else {
            elements.connectBtn.textContent = 'Connect';
            elements.connectBtn.onclick = () => sendConnectionRequest(currentUserId, profileId);
        }
    } catch (error) {
        console.error('Error checking connection:', error);
        elements.connectBtn.style.display = 'none';
    }
}

async function sendConnectionRequest(senderId, receiverId) {
    try {
        elements.connectBtn.disabled = true;
        elements.connectBtn.textContent = 'Sending...';
        
        const { error } = await supabase
            .from('connections')
            .insert([{
                sender_id: senderId,
                receiver_id: receiverId,
                status: 'pending'
            }]);

        if (error) throw error;
        
        elements.connectBtn.textContent = 'Pending';
    } catch (error) {
        console.error('Error sending connection:', error);
        elements.connectBtn.textContent = 'Connect';
        elements.connectBtn.disabled = false;
        showError('Failed to send connection request');
    }
}

async function acceptConnection(connectionId) {
    try {
        elements.connectBtn.disabled = true;
        elements.connectBtn.textContent = 'Accepting...';
        
        const { error } = await supabase
            .from('connections')
            .update({ status: 'accepted' })
            .eq('id', connectionId);

        if (error) throw error;
        
        elements.connectBtn.textContent = 'Connected';
        await updateConnectionsCount();
    } catch (error) {
        console.error('Error accepting connection:', error);
        elements.connectBtn.textContent = 'Accept';
        elements.connectBtn.disabled = false;
        showError('Failed to accept connection');
    }
}

async function updateConnectionsCount() {
    try {
        const { count, error } = await supabase
            .from('connections')
            .select('*', { count: 'exact', head: true })
            .or(`and(sender_id.eq.${profileId},status.eq.accepted),and(receiver_id.eq.${profileId},status.eq.accepted)`);

        if (error) throw error;
        
        elements.connectionsCount.textContent = count || 0;
    } catch (error) {
        console.error('Error updating connections count:', error);
    }
}

// Error handling
function showError(message) {
    elements.skeleton.style.display = 'none';
    elements.errorMessage.textContent = message;
    elements.errorMessage.style.display = 'block';
}

// Share profile function
function shareProfile() {
    const profileUrl = `${window.location.origin}${window.location.pathname}?id=${profileId}`;
    
    if (navigator.share) {
        navigator.share({
            title: `${elements.fullName.textContent}'s Profile`,
            url: profileUrl
        }).catch(err => {
            console.log('Error sharing:', err);
            copyToClipboard(profileUrl);
        });
    } else {
        copyToClipboard(profileUrl);
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('Profile link copied to clipboard!');
    });
}

function toggleOptions() {
    // Implementation for options menu
    console.log("Options menu clicked");
}

async function openEditProfile() {
    // Check if we're viewing our own profile
    const { data: { user } } = await supabase.auth.getUser();
    if (user.id === profileId) {
        openEditModal(); // Open the new modal editor
    } else {
        // Existing behavior for other profiles
        window.location.href = `edit-profile.html?id=${profileId}`;
    }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', loadProfile);
    </script>

    <script>
        async function loadUserPosts(userId) {
            const { data: posts, error } = await supabase
                .from('posts')
                .select(`
                    *,
                    profile:user_id (username, full_name, avatar_url, is_verified),
                    media:post_media (media_url, media_type)
                `)
                .eq('user_id', userId)
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error("Error loading user posts:", error);
                return;
            }
            
            const postsContainer = document.getElementById('user-posts');
            postsContainer.innerHTML = '';
            
            posts.forEach(post => {
                const postElement = document.createElement('post-component');
                postElement.setAttribute('post-data', JSON.stringify(post));
                postsContainer.appendChild(postElement);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Get user ID from URL or current user
            const userId = getUserIdFromUrl() || currentUser?.id;
            if (userId) loadUserPosts(userId);
        });
    </script>

    <script>
    // Verify custom element is registered
    if (!customElements.get('post-component')) {
        console.error('Post component not registered! Loading posts.js');
        const script = document.createElement('script');
        script.src = 'posts.js';
        document.body.appendChild(script);
        
        // Retry loading posts after component is loaded
        script.onload = loadPosts;
    }
</script>
      <script src="posts.js"></script>
    <script src="edit.js"></script>
</body>
</html>
