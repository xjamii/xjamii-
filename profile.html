<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviationin Profile</title>
    <link rel="stylesheet" href="posts.css">
    <link rel="stylesheet" href="experience.css">
    <link rel="stylesheet" href="edit.css">
     <link rel="stylesheet" href="skills.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* [Keep all your existing CSS styles] */
     /* Base Styles */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f5f7fa;
    color: #333;
    line-height: 1.6;
}

/* Header Styles */
.profile-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background-color: white;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.back-button {
    color: #0056b3;
    font-size: 18px;
    text-decoration: none;
}

.header-name {
    font-weight: 600;
    font-size: 18px;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}

.edit-button, .more-options {
    color: #0056b3;
    font-size: 16px;
    cursor: pointer;
    display: none;
}

/* Profile Content Styles */
.profile-content {
    margin-top: 60px;
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    margin-bottom: 20px;
}

.cover-photo {
    height: 300px;
    background-color: #0056b3;
    background-size: cover;
    background-position: center;
    position: relative;
}

/* Profile Info Styles */
.profile-info {
    text-align: center;
    padding: 20px;
    position: relative;
    margin-top: -70px;
}

.avatar {
    width: 200px;
    height: 200px;
    border-radius: 50%;
    border: 5px solid white;
    object-fit: cover;
    margin-bottom: 7px;
}

.profile-details {
    margin-top: 10px;
}

.profile-name {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 5px;
    margin-bottom: 5px;
    margin-left: 25px; /* ‚Üê Add this line to move it right */
}

.profile-name h1 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
}

.verified-badge {
    color: #1DA1F2;
    font-size: 16px;
    display: none;
}

.username {
    color: #666;
    font-size: 16px;
    margin-bottom: 10px;
}

.connections {
    color: #666;
    font-size: 14px;
    margin-bottom: 15px;
}

.bio {
    color: #444;
    font-size: 15px;
    margin: 15px auto;
    max-width: 80%;
    line-height: 1.5;
}

.website-link {
    color: #0056b3;
    text-decoration: none;
    font-size: 14px;
    display: block;
    margin-bottom: 15px;
}

.category-badge {
    background-color: #0056b3;
    color: #FFFFFF;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    display: inline-block;
    margin-bottom: 15px;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
}

.btn {
    padding: 10px 20px;
    border-radius: 20px;
    border: none;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn {
    background-color: #0056b3;
    color: white;
}

.btn-outline {
    background-color: white;
    color: #0056b3;
    border: 1px solid #0056b3;
}

.btn:hover {
    opacity: 0.9;
    transform: translateY(-2px);
}

/* Experience Section */
.experience-section, .skills-section {
    padding: 20px;
    border-top: 1px solid #eee;
}

.section-title {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 15px;
    color: #0056b3;
    display: flex;
    align-items: center;
    gap: 8px;
}

.experience-item {
    margin-bottom: 15px;
}

.experience-details {
    margin-left: 10px;
}

.experience-details .description {
    color: #444;
    font-size: 14px;
    line-height: 1.6;
}

/* Skills Section */
.skills-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.skill-badge {
    background-color: #0056b3;
    color: #FFFFFF;
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 15px; /* Increased from 13px */
    font-weight: 500;
    margin-top: 10px; /* Added to move it slightly down */
}

/* Responsive Adjustments */
@media (max-width: 480px) {
    .profile-info {
        padding: 15px;
    }
    
    .bio {
        max-width: 95%;
    }
    
    .action-buttons {
        flex-direction: column;
        align-items: center;
    }
    
    .btn {
        width: 100%;
        max-width: 200px;
    }
}

.grid-posts-header {
  text-align: center;
  padding: 25px 0;
}

.grid-icon {
  display: grid;
  grid-template-columns: repeat(3, 6px);
  grid-gap: 3px;
  margin: 0 auto 8px;
  width: fit-content;
}

.grid-icon span {
  display: block;
  width: 6px;
  height: 6px;
  background: #0056b3;
}

.grid-posts-header h3 {
  margin: 8px 0 0;
  font-size: 14px;
  font-weight: 600;
  color: #0056b3;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Full Page Loader */
.full-page-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #FFFFFF;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(2px);
}

.spinner-container {
    text-align: center;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #e6f0ff;
    border-top: 4px solid #0056b3;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

.loading-text {
    color: #0056b3;
    font-weight: 500;
    font-size: 16px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

        .full-page-loader {
    transition: opacity 0.3s ease;
}

        .blue-line {
    height: 4px;
    background-color: #0056b3;
    width: 100%;
    margin-top: 8px;
}

        /* Full Page Loader */
.full-page-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #FFFFFF;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(2px);
}

.spinner-container {
    text-align: center;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #e6f0ff;
    border-top: 4px solid #0056b3;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.full-page-loader {
    transition: opacity 0.3s ease;
}
    </style>
</head>
<body>
    <!-- Full Page Loader -->
    <div class="full-page-loader" id="full-page-loader">
        <div class="spinner-container">
            <div class="spinner"></div>
        </div>
    </div>

    
    <!-- Header with Back Button and Options -->
    <div class="profile-header">
        <div class="header-left">
            <a href="index.html" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div class="header-name" id="profile-name">Profile</div>
        </div>
        <div class="header-actions">
            <div class="edit-button" id="edit-button">
                <i class="fas fa-pencil-alt"></i>
            </div>
            <div class="more-options" onclick="toggleOptions()">
                <i class="fas fa-ellipsis-h"></i>
            </div>
        </div>
    </div>

    <!-- Profile Content -->
    <div class="profile-content">
        <div class="cover-photo" id="cover-photo"></div>
        
        <div class="full-page-loader" id="full-page-loader">
    <div class="spinner-container">
        <div class="spinner"></div>
        
    </div>
</div>
        
        <!-- Error Message Container -->
        <div class="error-message" id="error-message"></div>
        
        <!-- Actual Profile Content (hidden initially) -->
        <div class="profile-info" id="profile-info" style="display: none;">
            <img src="" alt="Profile Avatar" class="avatar" id="profile-avatar">
            <div class="profile-details">
                <div class="profile-name">
                    <h1 id="full-name">Loading...</h1>
                    <i class="fas fa-check-circle verified-badge" id="verified-badge"></i>
                </div>
                <div class="username" id="username">@loading</div>
                <div class="connections">
                    <i class="fas fa-link"></i> <span id="connections-count">0</span> Connections
                </div>
                <p class="bio" id="bio">
                    Loading profile information...
                </p>
                <a href="#" class="website-link" id="website-link" style="display: none;"></a>
                <div class="category-badge" id="category-badge" style="display: none;"></div>
                <div class="action-buttons">
                    <button class="btn" id="connect-btn">Connect</button>
                    <button class="btn btn-outline" id="message-btn" style="display: none;">
        <i class="fas fa-envelope"></i> Message
    </button>
                    <button class="btn btn-outline" onclick="shareProfile()"><i class="fas fa-share"></i></button>
                </div>
            </div>
        </div>

        <!-- Experience Section -->
<div class="experience-section" id="experience-section" style="display: none;">
    <div class="section-header">
        <h2 class="section-title"><i class="fas fa-briefcase"></i> Professional Experience</h2>
        <button class="edit-section-btn" id="edit-experience-btn">
            <i class="fas fa-pencil-alt"></i> Edit
        </button>
    </div>
    <div id="experience-container">
        <div class="experience-item">
            <div class="experience-details">
                <div class="description" id="experience-text">Loading experience...</div>
            </div>
        </div>
    </div>
</div>
        
        <!-- Skills Section -->
<div class="skills-section" id="skills-section" style="display: none;">
    <h2 class="section-title">
        <i class="fas fa-star"></i> Skills & Endorsements
    </h2>
    <div class="skills-list" id="skills-container">
        <div class="skill-badge">Loading skills...</div>
    </div>
</div>

       <div class="grid-posts-header">
  <div class="grid-icon">
    <span></span><span></span><span></span>
    <span></span><span></span><span></span>
    <span></span><span></span><span></span>
  </div>
  <h3>POSTS</h3>
  <div class="blue-line"></div>
</div>
    <div id="user-posts">
        <!-- User posts will be loaded here -->
    </div>
    
    <!-- Edit Profile Modal -->
<div id="edit-profile-page" style="display: none;">
    <div class="edit-profile-header">
        <div class="header-left">
            <button class="back-button" id="back-from-edit">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="header-name">Edit Profile</div>
        </div>
        <button class="btn btn-save" id="save-profile-changes">Save</button>
    </div>

    <div class="edit-profile-content">
        <div class="preloader" id="edit-preloader">
            <div class="spinner"></div>
        </div>

        <form id="edit-profile-form">
            <!-- Cover Photo Section -->
            <div class="form-group cover-photo-section">
                <div class="cover-photo-container" id="edit-cover-container">
                    <img id="cover-preview" class="cover-preview" src="" alt="Cover Preview">
                    <label for="edit-cover-upload" class="cover-upload-label">
                        <i class="fas fa-camera"></i> Change Cover
                    </label>
                    <input type="file" id="edit-cover-upload" class="file-input" accept="image/*">
                </div>
            </div>
            
            <!-- Profile Picture Section -->
            <div class="form-group avatar-section">
                <img id="avatar-preview" class="avatar-preview" src="" alt="Avatar Preview">
                <label for="edit-avatar-upload" class="avatar-upload-label">
                    <i class="fas fa-camera"></i> Change Photo
                </label>
                <input type="file" id="edit-avatar-upload" class="file-input" accept="image/*">
            </div>
            
            <!-- Basic Info Section -->
            <div class="form-section">
                <h3 class="section-title">Basic Information</h3>
                
                <div class="form-group">
                    <label for="edit-full-name">Full Name</label>
                    <input type="text" id="edit-full-name" required>
                </div>
                
                <div class="form-group">
                    <label for="edit-username">Username</label>
                    <input type="text" id="edit-username" required>
                    <div class="username-availability" id="username-availability"></div>
                </div>
                
                <div class="form-group">
                    <label for="edit-bio">Bio</label>
                    <textarea id="edit-bio" placeholder="Tell others about yourself"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="edit-website">Website</label>
                    <input type="url" id="edit-website" placeholder="https://example.com">
                </div>
            </div>
            
            <!-- Professional Section -->
            <div class="form-section">
                <h3 class="section-title">Professional Information</h3>
                
                <div class="form-group">
                    <label for="edit-category">Professional Category</label>
                    <select id="edit-category" class="category-select">
                        <option value="">Select your category</option>
                        <!-- Categories will be populated by JS -->
                    </select>
                </div>
            </div>
        </form>
    </div>
</div>

    <!-- Experience Editor Page -->
<div id="experience-page" style="display: none;">
    <div class="experience-header">
        <div class="header-left">
            <button class="back-button" id="back-from-experience">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="header-name">Edit Experience</div>
        </div>
        <button class="btn btn-save" id="save-experience">Save</button>
    </div>

    <div class="experience-content">
        <div class="preloader" id="experience-preloader">
            <div class="spinner"></div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label for="experience-position">Position*</label>
                <input type="text" id="experience-position" placeholder="e.g., Captain, First Officer" required>
            </div>
            
            <div class="form-group">
                <label for="experience-company">Company*</label>
                <input type="text" id="experience-company" placeholder="e.g., Emirates, Delta Airlines" required>
            </div>
            
            <div class="form-group">
                <label>Duration*</label>
                <div class="duration-fields">
                    <div class="date-field">
                        <label for="experience-start-month">Start Month</label>
                        <select id="experience-start-month" required>
                            <option value="">Month</option>
                            <!-- Months will be populated by JS -->
                        </select>
                    </div>
                    <div class="date-field">
                        <label for="experience-start-year">Start Year</label>
                        <select id="experience-start-year" required>
                            <option value="">Year</option>
                            <!-- Years will be populated by JS -->
                        </select>
                    </div>
                    <div class="date-field">
                        <label for="experience-end-month">End Month</label>
                        <select id="experience-end-month">
                            <option value="">Month</option>
                            <!-- Months will be populated by JS -->
                        </select>
                    </div>
                    <div class="date-field">
                        <label for="experience-end-year">End Year</label>
                        <select id="experience-end-year">
                            <option value="">Year</option>
                            <!-- Years will be populated by JS -->
                        </select>
                    </div>
                </div>
                <div class="current-role">
                    <input type="checkbox" id="experience-current">
                    <label for="experience-current">I currently work here</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="experience-description">Description</label>
                <textarea id="experience-description" placeholder="Describe your responsibilities and achievements"></textarea>
            </div>
            
            <button class="btn btn-delete" id="delete-experience" style="display: none;">
                <i class="fas fa-trash"></i> Delete Experience
            </button>
        </div>
    </div>
</div>



        <!-- Skills Editor Page -->
<div id="skills-page" style="display: none;">
    <div class="skills-header">
        <div class="header-left">
            <button class="back-button" id="back-from-skills">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="header-name">Edit Skills</div>
        </div>
        <button class="btn btn-save" id="save-skills">Save</button>
    </div>

    <div class="skills-content">
        <div class="preloader" id="skills-preloader">
            <div class="spinner"></div>
        </div>

        <div class="form-section">
            <div class="selected-skills">
                <p>Selected Skills: <span id="selected-count">0</span>/10</p>
                <div class="skills-chips" id="skills-chips"></div>
            </div>
            
            <div class="skills-search">
                <input type="text" id="skills-search" placeholder="Search skills...">
            </div>
            
            <div class="skills-grid" id="skills-grid">
                <!-- Skills will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>
    <script>
        
// Initialize Supabase
const supabaseUrl = "https://dadrhoxjhjbnhhrtkgbf.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhZHJob3hqaGpibmhocnRrZ2JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1OTk2NTksImV4cCI6MjA2NjE3NTY1OX0.rn2hv0sXbKJyniN3FtpNpuyTvcXP1nTLj-jpnimRMEI";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// DOM Elements
const elements = {
    searchInput: document.getElementById('search-input'),
    tabs: document.querySelectorAll('.search-tab'),
    sections: document.querySelectorAll('.search-section'),
    profilesResults: document.getElementById('profiles-results'),
    postsResults: document.getElementById('posts-results'),
    profilesNoResults: document.getElementById('profiles-no-results'),
    postsNoResults: document.getElementById('posts-no-results'),
    profilesLoading: document.getElementById('profiles-loading'),
    postsLoading: document.getElementById('posts-loading'),
    suggestionsContainer: document.getElementById('suggestions-container'),
    suggestionsResults: document.getElementById('suggestions-results'),
    profilesScrollLoader: document.getElementById('profiles-scroll-loader'),
    postsScrollLoader: document.getElementById('posts-scroll-loader'),
    fullPageLoader: document.getElementById('full-page-loader')
};

// Variables
let currentTab = 'profiles';
let searchTimeout;
let lastSearchTerm = '';
let profilesPage = 0;
let postsPage = 0;
let isProfilesLoading = false;
let isPostsLoading = false;
let hasMoreProfiles = true;
let hasMorePosts = true;
let currentUserId = null;

// Event Listeners
elements.searchInput.addEventListener('input', handleSearchInput);

elements.tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        elements.tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        
        elements.sections.forEach(section => section.classList.remove('active'));
        document.getElementById(`${currentTab}-section`).classList.add('active');
        
        if (currentTab === 'profiles') {
            profilesPage = 0;
            hasMoreProfiles = true;
        } else {
            postsPage = 0;
            hasMorePosts = true;
        }
        
        if (lastSearchTerm.trim()) {
            performSearch(lastSearchTerm);
        } else if (currentTab === 'profiles') {
            loadSuggestedProfiles();
        }
    });
});

// Infinite scroll
window.addEventListener('scroll', handleScroll);

// Initialize
document.addEventListener('DOMContentLoaded', async () => {
    // Show preloader immediately
    elements.fullPageLoader.style.display = 'flex';
    
    try {
        // Check authentication
        const { data: { user }, error: authError } = await supabase.auth.getUser();
        
        if (authError || !user) {
            window.location.href = 'login.html';
            return;
        }
        
        currentUserId = user.id;
        
        // Focus search input
        elements.searchInput.focus();
        
        // Load suggested profiles
        await loadSuggestedProfiles();
        
        // Hide preloader
        elements.fullPageLoader.style.display = 'none';
    } catch (error) {
        console.error('Initialization error:', error);
        window.location.href = 'login.html';
    }
});

// Functions
async function handleScroll() {
    const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
    const nearBottom = scrollTop + clientHeight >= scrollHeight - 500;

    if (nearBottom && !isProfilesLoading && !isPostsLoading) {
        if (currentTab === 'profiles' && hasMoreProfiles && lastSearchTerm) {
            profilesPage++;
            await loadMoreProfiles();
        } else if (currentTab === 'posts' && hasMorePosts && lastSearchTerm) {
            postsPage++;
            await loadMorePosts();
        }
    }
}

async function handleSearchInput(e) {
    const searchTerm = e.target.value.trim();
    lastSearchTerm = searchTerm;
    
    clearTimeout(searchTimeout);
    
    if (searchTerm.length === 0) {
        clearResults();
        if (currentTab === 'profiles') {
            elements.suggestionsContainer.style.display = 'block';
            loadSuggestedProfiles();
        }
        return;
    }
    
    elements.suggestionsContainer.style.display = 'none';
    
    if (currentTab === 'profiles') {
        profilesPage = 0;
        hasMoreProfiles = true;
        elements.profilesResults.innerHTML = '';
    } else {
        postsPage = 0;
        hasMorePosts = true;
        elements.postsResults.innerHTML = '';
    }
    
    showLoading();
    
    searchTimeout = setTimeout(() => {
        performSearch(searchTerm);
    }, 500);
}

function showLoading() {
    if (currentTab === 'profiles') {
        elements.profilesLoading.style.display = 'block';
        elements.profilesNoResults.style.display = 'none';
    } else {
        elements.postsLoading.style.display = 'block';
        elements.postsNoResults.style.display = 'none';
    }
}

function hideLoading() {
    if (currentTab === 'profiles') {
        elements.profilesLoading.style.display = 'none';
    } else {
        elements.postsLoading.style.display = 'none';
    }
}

function clearResults() {
    if (currentTab === 'profiles') {
        elements.profilesResults.innerHTML = '';
        elements.profilesNoResults.style.display = 'block';
    } else {
        elements.postsResults.innerHTML = '';
        elements.postsNoResults.style.display = 'block';
    }
}

async function performSearch(searchTerm) {
    try {
        elements.fullPageLoader.style.display = 'flex';
        
        if (currentTab === 'profiles') {
            await searchProfiles(searchTerm);
        } else {
            await searchPosts(searchTerm);
        }
        
        elements.fullPageLoader.style.display = 'none';
    } catch (error) {
        console.error('Search error:', error);
        elements.fullPageLoader.style.display = 'none';
        showNoResults();
    }
}

async function searchProfiles(searchTerm) {
    const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .or(`full_name.ilike.%${searchTerm}%,username.ilike.%${searchTerm}%`)
        .limit(20);
    
    hideLoading();
    
    if (error) throw error;
    
    elements.profilesResults.innerHTML = '';
    
    if (!data || data.length === 0) {
        elements.profilesNoResults.innerHTML = `
            <i class="fas fa-user-slash" style="font-size: 24px; margin-bottom: 10px;"></i>
            <div>No professionals found for "${searchTerm}"</div>
        `;
        elements.profilesNoResults.style.display = 'block';
        return;
    }
    
    appendProfilesResults(data);
    
    if (currentUserId) {
        await updateConnectionStatuses(data);
    }
}

async function searchPosts(searchTerm) {
    const { data, error } = await supabase
        .from('posts')
        .select(`
            *,
            profile:profiles(*),
            media:post_media(*)
        `)
        .ilike('content', `%${searchTerm}%`)
        .order('created_at', { ascending: false })
        .limit(20);
    
    hideLoading();
    
    if (error) throw error;
    
    elements.postsResults.innerHTML = '';
    
    if (!data || data.length === 0) {
        elements.postsNoResults.innerHTML = `
            <i class="fas fa-comment-slash" style="font-size: 24px; margin-bottom: 10px;"></i>
            <div>No posts found for "${searchTerm}"</div>
        `;
        elements.postsNoResults.style.display = 'block';
        return;
    }
    
    appendPostsResults(data);
}

async function loadMoreProfiles() {
    if (isProfilesLoading || !hasMoreProfiles) return;
    
    isProfilesLoading = true;
    elements.profilesScrollLoader.style.display = 'block';
    
    const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .or(`full_name.ilike.%${lastSearchTerm}%,username.ilike.%${lastSearchTerm}%`)
        .range(profilesPage * 20, (profilesPage + 1) * 20 - 1);
    
    isProfilesLoading = false;
    elements.profilesScrollLoader.style.display = 'none';
    
    if (error) {
        console.error('Error loading more profiles:', error);
        return;
    }
    
    if (!data || data.length === 0) {
        hasMoreProfiles = false;
        return;
    }
    
    appendProfilesResults(data);
    
    if (currentUserId) {
        await updateConnectionStatuses(data);
    }
}

async function loadMorePosts() {
    if (isPostsLoading || !hasMorePosts) return;
    
    isPostsLoading = true;
    elements.postsScrollLoader.style.display = 'block';
    
    const { data, error } = await supabase
        .from('posts')
        .select(`
            *,
            profile:profiles(*),
            media:post_media(*)
        `)
        .ilike('content', `%${lastSearchTerm}%`)
        .order('created_at', { ascending: false })
        .range(postsPage * 20, (postsPage + 1) * 20 - 1);
    
    isPostsLoading = false;
    elements.postsScrollLoader.style.display = 'none';
    
    if (error) {
        console.error('Error loading more posts:', error);
        return;
    }
    
    if (!data || data.length === 0) {
        hasMorePosts = false;
        return;
    }
    
    appendPostsResults(data);
}

function appendProfilesResults(profiles) {
    profiles.forEach(profile => {
        const profileElement = createProfileElement(profile);
        elements.profilesResults.appendChild(profileElement);
    });
}

function appendPostsResults(posts) {
    posts.forEach(post => {
        const postElement = createPostElement(post);
        elements.postsResults.appendChild(postElement);
    });
}

function createProfileElement(profile) {
    const profileElement = document.createElement('div');
    profileElement.className = 'profile-result';
    
    const avatarUrl = profile.avatar_url || getInitialsAvatar(profile.full_name);
    const isCurrentUser = currentUserId === profile.id;
    
    profileElement.innerHTML = `
        <a href="/profile.html?id=${profile.id}" class="profile-link">
            <img src="${avatarUrl}" 
                 class="profile-avatar" 
                 onerror="this.src='${getInitialsAvatar(profile.full_name)}'">
            <div class="profile-info">
                <div class="profile-name">
                    ${profile.full_name || 'Aviation Professional'}
                    ${profile.is_verified ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}
                </div>
                <div class="profile-username">@${profile.username || 'user'}</div>
            </div>
        </a>
        ${isCurrentUser ? '' : '<button class="connect-btn" data-user-id="' + profile.id + '">Connect</button>'}
    `;
    
    if (!isCurrentUser) {
        const connectBtn = profileElement.querySelector('.connect-btn');
        connectBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            const userId = e.currentTarget.dataset.userId;
            await handleConnection(userId, e.currentTarget);
        });
    }
    
    return profileElement;
}

function createPostElement(post) {
    const postElement = document.createElement('post-component');
    const processedPost = {
        ...post,
        profile: post.profile,
        media: (post.media || []).map(mediaItem => ({
            ...mediaItem,
            media_url: mediaItem.media_url.startsWith('http') 
                ? mediaItem.media_url 
                : `${supabaseUrl}/storage/v1/object/public/${mediaItem.media_url}`
        }))
    };
    postElement.setAttribute('post-data', JSON.stringify(processedPost));
    return postElement;
}

async function loadSuggestedProfiles() {
    try {
        if (!currentUserId) return;
        
        const { data, error } = await supabase.rpc('get_suggested_profiles', {
            current_user_id: currentUserId,
            limit_count: 10
        });
        
        if (error) throw error;
        
        elements.suggestionsResults.innerHTML = '';
        
        if (!data || data.length === 0) {
            elements.suggestionsContainer.style.display = 'none';
            return;
        }
        
        data.forEach(profile => {
            const profileElement = createProfileElement(profile);
            elements.suggestionsResults.appendChild(profileElement);
        });
        
        await updateConnectionStatuses(data);
        
    } catch (error) {
        console.error('Error loading suggestions:', error);
        elements.suggestionsContainer.style.display = 'none';
    }
}

async function updateConnectionStatuses(profiles) {
    if (!currentUserId) return;
    
    const { data: connections, error } = await supabase
        .from('connections')
        .select('*')
        .or(`and(sender_id.eq.${currentUserId},receiver_id.in.(${profiles.map(p => `"${p.id}"`).join(',')})),and(sender_id.in.(${profiles.map(p => `"${p.id}"`).join(',')}),receiver_id.eq.${currentUserId})`);
    
    if (error) {
        console.error('Error fetching connections:', error);
        return;
    }
    
    profiles.forEach(profile => {
        if (profile.id === currentUserId) return;
        
        const connection = connections.find(c => 
            (c.sender_id === currentUserId && c.receiver_id === profile.id) ||
            (c.sender_id === profile.id && c.receiver_id === currentUserId)
        );
        
        const connectBtn = document.querySelector(`.connect-btn[data-user-id="${profile.id}"]`);
        if (!connectBtn) return;
        
        if (connection) {
            if (connection.status === 'pending') {
                if (connection.sender_id === currentUserId) {
                    connectBtn.textContent = 'Pending';
                    connectBtn.classList.add('pending');
                    connectBtn.classList.remove('connected');
                } else {
                    connectBtn.textContent = 'Accept';
                    connectBtn.classList.remove('pending', 'connected');
                }
            } else if (connection.status === 'accepted') {
                connectBtn.textContent = 'Connected';
                connectBtn.classList.add('connected');
                connectBtn.classList.remove('pending');
            }
        } else {
            connectBtn.textContent = 'Connect';
            connectBtn.classList.remove('pending', 'connected');
        }
    });
}

async function handleConnection(userId, button) {
    try {
        if (!currentUserId) {
            const { data: { user }, error: authError } = await supabase.auth.getUser();
            
            if (authError || !user) {
                window.location.href = 'login.html';
                return;
            }
            
            currentUserId = user.id;
        }
        
        const { data: connection, error: connectionError } = await supabase
            .from('connections')
            .select('id, sender_id, status')
            .or(`and(sender_id.eq.${currentUserId},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUserId})`)
            .single();
        
        if (connectionError && connectionError.code !== 'PGRST116') throw connectionError;
        
        if (connection) {
            if (connection.status === 'pending') {
                if (connection.sender_id === currentUserId) {
                    await supabase
                        .from('connections')
                        .delete()
                        .eq('id', connection.id);
                    
                    button.textContent = 'Connect';
                    button.classList.remove('pending', 'connected');
                } else {
                    await supabase
                        .from('connections')
                        .update({ status: 'accepted' })
                        .eq('id', connection.id);
                    
                    button.textContent = 'Connected';
                    button.classList.add('connected');
                    button.classList.remove('pending');
                }
            } else if (connection.status === 'accepted') {
                await supabase
                    .from('connections')
                    .delete()
                    .eq('id', connection.id);
                
                button.textContent = 'Connect';
                button.classList.remove('pending', 'connected');
            }
        } else {
            await supabase
                .from('connections')
                .insert([{
                    sender_id: currentUserId,
                    receiver_id: userId,
                    status: 'pending'
                }]);
            
            button.textContent = 'Pending';
            button.classList.add('pending');
            button.classList.remove('connected');
        }
    } catch (error) {
        console.error('Connection error:', error);
        alert('Failed to update connection. Please try again.');
    }
}

function getInitialsAvatar(name) {
    const initials = name ? 
        name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'U';
    return `data:image/svg+xml;charset=UTF-8,<svg xmlns='http://www.w3.org/2000/svg' width='50' height='50'><rect width='50' height='50' fill='%230056b3'/><text x='50%' y='50%' font-size='20' fill='white' text-anchor='middle' dy='.3em'>${initials}</text></svg>`;
}

function showNoResults() {
    if (currentTab === 'profiles') {
        elements.profilesNoResults.style.display = 'block';
    } else {
        elements.postsNoResults.style.display = 'block';
    }
}



</script>
      <script src="posts.js"></script>
      <script src="skills.js"></script>
      <script src="experience.js"></script>
    <script src="edit.js"></script>
</body>
</html>
